<!--! ================================================================ !-->
    <!--! [Start] Main Content !-->
    <!--! ================================================================ !-->
    <main class="nxl-container">
        <div class="nxl-content">
            <!-- [ page-header ] start -->
            <div class="page-header">
                <div class="page-header-left d-flex align-items-center">
                    <div class="page-header-title">
                        <h5 class="m-b-10">Dashboard</h5>
                        <p class="text-muted mb-0">WhatsApp Service Overview</p>
                    </div>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                        <li class="breadcrumb-item">Dashboard</li>
                    </ul>
                </div>
                <div class="page-header-right ms-auto">
                    <div class="page-header-right-items">
                        <div class="d-flex d-md-none">
                            <a href="javascript:void(0)" class="page-header-right-close-toggle">
                                <i class="feather-arrow-left me-2"></i>
                                <span>Back</span>
                            </a>
                        </div>
                        <div class="d-flex align-items-center gap-2 page-header-right-items-wrapper">
                            <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
                                <i class="feather-refresh-cw me-2"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="d-md-none d-flex align-items-center">
                        <a href="javascript:void(0)" class="page-header-right-open-toggle">
                            <i class="feather-align-right fs-20"></i>
                        </a>
                    </div>
                </div>
            </div>
            <!-- [ page-header ] end -->

            <!-- [ Main Content ] start -->
            <div class="main-content">
                <!-- [ Statistics Cards ] start -->
                <div class="row">
                    <!-- [Total Sessions] start -->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card stretch stretch-full">
                            <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between mb-4">
                                    <div class="d-flex gap-4 align-items-center">
                                        <div class="avatar-text avatar-lg bg-primary">
                                            <i class="feather-smartphone"></i>
                                        </div>
                                        <div>
                                            <div class="fs-4 fw-bold text-dark">
                                                <span id="totalSessions" class="counter">0</span>
                                            </div>
                                            <h3 class="fs-13 fw-semibold text-truncate-1-line">Total Sessions</h3>
                                        </div>
                                    </div>
                                </div>
                                    <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-success" id="readySessions">0 Ready</span>
                                        <span class="badge bg-warning" id="disconnectedSessions">0 Disconnected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- [Total Sessions] end -->

                    <!-- [Total Broadcast Lists] start -->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card stretch stretch-full">
                            <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between mb-4">
                                    <div class="d-flex gap-4 align-items-center">
                                        <div class="avatar-text avatar-lg bg-success">
                                            <i class="feather-list"></i>
                                        </div>
                                        <div>
                                            <div class="fs-4 fw-bold text-dark">
                                                <span id="totalBroadcastLists" class="counter">0</span>
                                            </div>
                                            <h3 class="fs-13 fw-semibold text-truncate-1-line">Broadcast Lists</h3>
                                        </div>
                                    </div>
                                </div>
                                    <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-info" id="totalContacts">0 Contacts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- [Total Broadcast Lists] end -->

                    <!-- [Total Campaigns] start -->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card stretch stretch-full">
                            <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between mb-4">
                                    <div class="d-flex gap-4 align-items-center">
                                        <div class="avatar-text avatar-lg bg-warning">
                                            <i class="feather-send"></i>
                                        </div>
                                        <div>
                                            <div class="fs-4 fw-bold text-dark">
                                                <span id="totalCampaigns" class="counter">0</span>
                                            </div>
                                            <h3 class="fs-13 fw-semibold text-truncate-1-line">Total Campaigns</h3>
                                        </div>
                                    </div>
                                </div>
                                    <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-success" id="successfulMessages">0 Sent</span>
                                        <span class="badge bg-danger" id="failedMessages">0 Failed</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- [Total Campaigns] end -->

                    <!-- [Total Messages] start -->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card stretch stretch-full">
                            <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between mb-4">
                                    <div class="d-flex gap-4 align-items-center">
                                        <div class="avatar-text avatar-lg bg-info">
                                            <i class="feather-message-circle"></i>
                                        </div>
                                        <div>
                                            <div class="fs-4 fw-bold text-dark">
                                                <span id="totalMessages" class="counter">0</span>
                                            </div>
                                            <h3 class="fs-13 fw-semibold text-truncate-1-line">Total Messages</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-primary" id="todayMessages">0 Today</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- [Total Messages] end -->
                                    </div>
                <!-- [ Statistics Cards ] end -->

                <!-- [ WhatsApp Sessions Status ] start -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="feather-smartphone me-2"></i>
                                    WhatsApp Sessions Status
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Session ID</th>
                                                <th>Status</th>
                                                <th>Phone Number</th>
                                                <th>Last Activity</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sessionsTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    <i class="feather-loader me-2"></i>
                                                    Loading sessions...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                                    </div>
                <!-- [ WhatsApp Sessions Status ] end -->

                <!-- [ Recent Broadcasts ] start -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="feather-send me-2"></i>
                                    Recent Broadcasts
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>List Name</th>
                                                <th>Contacts</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentBroadcastsTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    <i class="feather-loader me-2"></i>
                                                    Loading broadcasts...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- [ Recent Broadcasts ] end -->

                <!-- [ Quick Actions ] start -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="feather-zap me-2"></i>
                                    Quick Actions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <a href="/broadcast" class="btn btn-primary w-100">
                                            <i class="feather-plus me-2"></i>
                                            Create Broadcast
                                        </a>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <a href="/sessions" class="btn btn-success w-100">
                                            <i class="feather-smartphone me-2"></i>
                                            Manage Sessions
                                        </a>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <a href="/contact" class="btn btn-info w-100">
                                            <i class="feather-users me-2"></i>
                                            Manage Contacts
                                        </a>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <a href="/users" class="btn btn-warning w-100">
                                            <i class="feather-user me-2"></i>
                                            Manage Users
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- [ Quick Actions ] end -->
            </div>
            <!-- [ Main Content ] end -->
        </div>
        <!-- [ Footer ] start -->
        <footer class="footer">
            <p class="fs-11 text-muted fw-medium text-uppercase mb-0 copyright">
                <span>Copyright ©</span>
                <script>
                    document.write(new Date().getFullYear());
                </script>
            </p>
            <div class="d-flex align-items-center gap-4">
                <a href="javascript:void(0);" class="fs-11 fw-semibold text-uppercase">Help</a>
                <a href="javascript:void(0);" class="fs-11 fw-semibold text-uppercase">Terms</a>
                <a href="javascript:void(0);" class="fs-11 fw-semibold text-uppercase">Privacy</a>
            </div>
        </footer>
        <!-- [ Footer ] end -->
    </main>
    <!--! ================================================================ !-->
    <!--! [End] Main Content !-->
    <!--! ================================================================ !-->

    <script>
        // Authentication check for protected pages
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token found, redirecting to login...');
                window.location.replace('/auth/login');
                return;
            }
            
            // Simple token validation
            if (token.length < 10) {
                console.log('Invalid token, redirecting to login...');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.replace('/auth/login');
                return;
            }
            
            console.log('Authentication successful, user can access dashboard');
        })();

        // Dashboard functionality
        let dashboardData = {};

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                console.log('🔄 Loading dashboard data...');

                // Load sessions (gunakan endpoint yang sama dengan sessions view)
                console.log('📱 Loading sessions...');
                const sessionsResponse = await fetch('/api/whatsapp/sessions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!sessionsResponse.ok) {
                    throw new Error(`Sessions API error: ${sessionsResponse.status} ${sessionsResponse.statusText}`);
                }
                const sessionsResponseData = await sessionsResponse.json();
                const sessionsData = sessionsResponseData.success ? sessionsResponseData.sessions : [];
                console.log('✅ Sessions loaded:', sessionsData);

                // Load broadcast lists
                console.log('📋 Loading broadcast lists...');
                const broadcastResponse = await fetch('/api/dashboard/lists', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!broadcastResponse.ok) {
                    throw new Error(`Broadcast lists API error: ${broadcastResponse.status} ${broadcastResponse.statusText}`);
                }
                const broadcastData = await broadcastResponse.json();
                console.log('✅ Broadcast lists loaded:', broadcastData);

                // Load campaigns
                console.log('📤 Loading campaigns...');
                const campaignsResponse = await fetch('/api/dashboard/campaigns', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!campaignsResponse.ok) {
                    throw new Error(`Campaigns API error: ${campaignsResponse.status} ${campaignsResponse.statusText}`);
                }
                const campaignsData = await campaignsResponse.json();
                console.log('✅ Campaigns loaded:', campaignsData);

                // Debug logging
                console.log('📊 Dashboard data loaded:');
                console.log('Sessions:', sessionsData);
                console.log('Broadcast Lists:', broadcastData);
                console.log('Campaigns:', campaignsData);

                // Process and display data
                processDashboardData(sessionsData, broadcastData, campaignsData);
            } catch (error) {
                console.error('❌ Error loading dashboard data:', error);
                showDashboardError(`Failed to load dashboard data: ${error.message}`);
            }
        }

        // Process dashboard data
        function processDashboardData(sessionsData, broadcastData, campaignsData) {
            console.log('🔄 Processing dashboard data...');
            console.log('Sessions data type:', typeof sessionsData, 'Length:', sessionsData?.length);
            console.log('Broadcast data type:', typeof broadcastData, 'Length:', broadcastData?.length);
            console.log('Campaigns data type:', typeof campaignsData, 'Length:', campaignsData?.length);
            
            // Update statistics
            updateStatistics(sessionsData, broadcastData, campaignsData);
            
            // Update sessions table
            updateSessionsTable(sessionsData);
            
            // Update recent broadcasts table
            updateRecentBroadcastsTable(broadcastData);
        }

        // Update statistics cards
        function updateStatistics(sessionsData, broadcastData, campaignsData) {
            console.log('🔄 Updating statistics...');
            
            // Sessions
            const totalSessions = sessionsData.length || 0;
            const readySessions = sessionsData.filter(s => s.isConnected).length || 0;
            const disconnectedSessions = totalSessions - readySessions;

            console.log(`📱 Sessions stats: Total=${totalSessions}, Connected=${readySessions}, Disconnected=${disconnectedSessions}`);

            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('readySessions').textContent = `${readySessions} Connected`;
            document.getElementById('disconnectedSessions').textContent = `${disconnectedSessions} Disconnected`;

            // Broadcast Lists
            const totalBroadcastLists = broadcastData.length || 0;
            const totalContacts = broadcastData.reduce((sum, list) => sum + (list.contact_count || 0), 0);

            console.log(`📋 Broadcast stats: Lists=${totalBroadcastLists}, Contacts=${totalContacts}`);

            document.getElementById('totalBroadcastLists').textContent = totalBroadcastLists;
            document.getElementById('totalContacts').textContent = `${totalContacts} Contacts`;

            // Campaigns
            const totalCampaigns = campaignsData.length || 0;
            const successfulMessages = campaignsData.reduce((sum, campaign) => sum + (campaign.success_count || 0), 0);
            const failedMessages = campaignsData.reduce((sum, campaign) => sum + (campaign.failed_count || 0), 0);

            console.log(`📤 Campaign stats: Total=${totalCampaigns}, Sent=${successfulMessages}, Failed=${failedMessages}`);

            document.getElementById('totalCampaigns').textContent = totalCampaigns;
            document.getElementById('successfulMessages').textContent = `${successfulMessages} Sent`;
            document.getElementById('failedMessages').textContent = `${failedMessages} Failed`;

            // Total Messages
            const totalMessages = successfulMessages + failedMessages;
            const todayMessages = campaignsData
                .filter(campaign => {
                    const today = new Date().toDateString();
                    const campaignDate = new Date(campaign.created_at).toDateString();
                    return today === campaignDate;
                })
                .reduce((sum, campaign) => sum + (campaign.success_count || 0), 0);

            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('todayMessages').textContent = `${todayMessages} Today`;
        }

        // Update sessions table
        function updateSessionsTable(sessionsData) {
            console.log('🔄 Updating sessions table with data:', sessionsData);
            const tbody = document.getElementById('sessionsTableBody');
            
            if (!sessionsData || sessionsData.length === 0) {
                console.log('⚠️ No sessions data, showing "No sessions found"');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="feather-alert-circle me-2"></i>
                            No sessions found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sessionsData.map(session => {
                const statusClass = session.isConnected ? 'success' : 'warning';
                const statusText = session.isConnected ? 'Connected' : 'Disconnected';
                const lastActivity = session.lastSeen ? new Date(session.lastSeen).toLocaleString() : 'Never';
                
                return `
                    <tr>
                        <td>
                            <code class="fs-12">${session.session_id}</code>
                        </td>
                        <td>
                            <span class="badge bg-${statusClass}">${statusText}</span>
                        </td>
                        <td>${session.description || 'N/A'}</td>
                        <td>${lastActivity}</td>
                        <td>
                            <a href="/sessions/detail?id=${session.session_id}" class="btn btn-sm btn-outline-primary">
                                <i class="feather-eye me-1"></i>
                                View
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update recent broadcasts table
        function updateRecentBroadcastsTable(broadcastData) {
            console.log('🔄 Updating broadcast table with data:', broadcastData);
            const tbody = document.getElementById('recentBroadcastsTableBody');
            
            if (!broadcastData || broadcastData.length === 0) {
                console.log('⚠️ No broadcast data, showing "No broadcast lists found"');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="feather-alert-circle me-2"></i>
                            No broadcast lists found
                        </td>
                    </tr>
                `;
                return;
            }

            // Show only recent 5 broadcasts
            const recentBroadcasts = broadcastData.slice(0, 5);
            
            tbody.innerHTML = recentBroadcasts.map(broadcast => {
                const createdDate = new Date(broadcast.created_at).toLocaleDateString();
                const contactCount = broadcast.contact_count || 0;
                
                return `
                    <tr>
                        <td>
                            <strong>${broadcast.name}</strong>
                            <br>
                            <small class="text-muted">${broadcast.description || 'No description'}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">${contactCount} contacts</span>
                        </td>
                        <td>
                            <span class="badge bg-success">Active</span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <a href="/broadcast" class="btn btn-sm btn-outline-primary">
                                <i class="feather-edit me-1"></i>
                                Edit
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show dashboard error
        function showDashboardError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show';
            errorDiv.innerHTML = `
                <i class="feather-alert-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(errorDiv, mainContent.firstChild);
        }

        // Refresh dashboard
        function refreshDashboard() {
            loadDashboardData();
        }

        // Load dashboard data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>